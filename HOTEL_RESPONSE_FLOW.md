## Hotel Response Flow Analysis

### Endpoint: `/api/v1/itineraries/hotel_room_details/:quoteId`

---

## DATA FLOW DIAGRAM

```
REQUEST (hotel_room_details/DVI2026011)
    ‚Üì
ItinerariesController.getItineraryHotelRoomDetails()
    ‚Üì
ItineraryHotelDetailsService.getHotelRoomDetailsByQuoteId()
    ‚Üì
[READS FROM DATABASE]:
    1. dvi_itinerary_plan_details (get planId from quoteId)
    2. dvi_itinerary_plan_hotel_details (get hotels for this plan)
    3. dvi_itinerary_route_details (get route info)
    4. dvi_hotel (get hotel master data)
    ‚Üì
RETURNS: ItineraryHotelRoomDetailsResponseDto
    (Built from database records)
```

---

## WHERE DATA COMES FROM

### Response Source: **DATABASE ONLY** ‚úÖ
- This endpoint is **100% database-driven**
- It does NOT call TBO API in real-time
- It reads pre-stored hotel details from database tables

### Database Tables Used:
1. **dvi_itinerary_plan_hotel_details** - Main source (hotel packages per route)
2. **dvi_itinerary_plan_details** - Plan lookup
3. **dvi_itinerary_route_details** - Route/destination info
4. **dvi_hotel** - Hotel master data

---

## WHERE DATABASE DATA COMES FROM

The database tables are populated when:

### Flow 1: Dynamic TBO API Call (When hotels are generated)
```
hotel_details endpoint
    ‚Üì
ItineraryHotelDetailsTboService.getHotelDetailsByQuoteIdFromTbo()
    ‚Üì
TBOHotelProvider.search() [CALLS TBO API]
    ‚Üì
Stores results ‚Üí dvi_itinerary_plan_hotel_details table
    ‚Üì
(Later) hotel_room_details reads from this table
```

### Flow 2: Manual Save (When user selects hotels)
```
PUT /itineraries/:id/hotel-selection
    ‚Üì
ItinerariesService.updateHotelDetails()
    ‚Üì
Saves to dvi_itinerary_plan_hotel_details
    ‚Üì
(Later) hotel_room_details reads from this table
```

---

## KEY DIFFERENCE

| Endpoint | Source | Real-Time API | Notes |
|----------|--------|---------------|-------|
| `hotel_details` | TBO API | ‚úÖ YES | Generates packages in real-time from TBO API |
| `hotel_room_details` | DATABASE | ‚ùå NO | Reads saved/cached hotel data from database |

---

## Current Issue for DVI2026011

If `hotel_room_details` is showing "No Hotels Available":

**Root Cause**: `dvi_itinerary_plan_hotel_details` table is empty for this quote
- Either: No hotels were ever generated (hotel_details endpoint failed)
- Or: Hotel details were cleared/not saved to database

**Solution Options**:
1. Call `hotel_details` first to generate/save hotels to DB
2. Then `hotel_room_details` will read those saved hotels

**Check**:
```sql
SELECT * FROM dvi_itinerary_plan_hotel_details 
WHERE itinerary_plan_id = 3;
```

---

## Summary

‚úÖ `hotel_room_details` = Database lookup (fast, cached)
üîÑ `hotel_details` = TBO API call (real-time, generates data)

The `hotel_room_details` endpoint depends on data being pre-generated by `hotel_details` 
and saved to the database.
