name: Deploy API to DigitalOcean

on:
  pull_request:
    types: [closed]
    branches: [main]
  push:
    branches: [main]

jobs:
  deploy:
    if: github.event_name == 'push' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: SSH & deploy on Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script_stop: true
          script: |
            set -e  # fail on any unhandled error

            APP_DIR="/var/node-projects/api.dvi.travel"
            DEPLOY_STATE_FILE="/var/node-projects/api.dvi.travel.last_deploy_sha"

            cd "$APP_DIR"

            echo "Reading last deployed SHA (if any)..."
            if [ -f "$DEPLOY_STATE_FILE" ]; then
              PREV_SHA=$(cat "$DEPLOY_STATE_FILE")
              echo "Previous deployed commit: $PREV_SHA"
            else
              PREV_SHA=""
              echo "No previous deploy SHA found (first deploy or manual setup)."
            fi

            echo "Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            NEW_SHA=$(git rev-parse HEAD)
            echo "New commit after pull: $NEW_SHA"

            # -------------------------------------------------------
            # 1. Detect Prisma schema change between PREV_SHA and NEW_SHA
            # -------------------------------------------------------
            RUN_PRISMA_PUSH=false
            if [ -n "$PREV_SHA" ]; then
              echo "Checking for Prisma schema changes..."
              if git diff --name-only "$PREV_SHA" "$NEW_SHA" | grep -q "prisma/schema.prisma"; then
                echo "âœ… Detected change in prisma/schema.prisma â€“ will run 'npx prisma db push'."
                RUN_PRISMA_PUSH=true
              else
                echo "â„¹ï¸ No changes in prisma/schema.prisma â€“ skipping 'prisma db push'."
              fi
            else
              echo "â„¹ï¸ No previous SHA recorded â€“ skipping automatic 'prisma db push' for safety."
            fi

            if [ "$RUN_PRISMA_PUSH" = true ]; then
              echo "Running Prisma DB push (will auto-answer 'no' to destructive prompts)..."
              # Temporarily disable 'set -e' so we can capture exit code
              set +e
              printf 'n\n' | npx prisma db push
              PRISMA_EXIT=$?
              set -e

              if [ $PRISMA_EXIT -ne 0 ]; then
                echo "âŒ Prisma db push failed or was aborted (answered 'no'). Failing deployment."
                exit 1
              fi

              echo "âœ… Prisma db push completed successfully."
            fi

            echo "Installing dependencies..."
            npm install

            echo "Building app..."
            NODE_OPTIONS="--max-old-space-size=4096" npm run build

            echo "Restarting PM2..."
            pm2 restart api.dvi.travel || pm2 start dist/src/main.js --name api.dvi.travel

            echo "Saving deployed SHA..."
            echo "$NEW_SHA" > "$DEPLOY_STATE_FILE"

            echo "ðŸŽ‰ Deployment completed successfully."
