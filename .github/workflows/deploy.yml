set -e  # keep global safety

APP_DIR="/var/node-projects/api.dvi.travel"
DEPLOY_STATE_FILE="/var/node-projects/api.dvi.travel.last_deploy_sha"

cd "$APP_DIR"

echo "Reading last deployed SHA (if any)..."
if [ -f "$DEPLOY_STATE_FILE" ]; then
  PREV_SHA=$(cat "$DEPLOY_STATE_FILE")
  echo "Previous deployed commit: $PREV_SHA"
else
  PREV_SHA=""
  echo "No previous deploy SHA found (first deploy or manual setup)."
fi

echo "Pulling latest code..."
git fetch origin main
git reset --hard origin/main

NEW_SHA=$(git rev-parse HEAD)
echo "New commit after pull: $NEW_SHA"

# -------------------------------------------------------
# Detect Prisma schema change
# -------------------------------------------------------
RUN_PRISMA_PUSH=false
if [ -n "$PREV_SHA" ]; then
  echo "Checking for Prisma schema changes between $PREV_SHA and $NEW_SHA ..."

  # Temporarily disable 'set -e' so a 'no match' doesn't kill the script
  set +e
  CHANGED_FILES=$(git diff --name-only "$PREV_SHA" "$NEW_SHA")
  DIFF_EXIT=$?
  set -e

  if [ $DIFF_EXIT -ne 0 ]; then
    echo "git diff failed (maybe history rewritten). Skipping prisma db push for safety."
  else
    if echo "$CHANGED_FILES" | grep -q "^prisma/schema.prisma$"; then
      echo "âœ… Detected change in prisma/schema.prisma â€“ will run 'npx prisma db push'."
      RUN_PRISMA_PUSH=true
    else
      echo "â„¹ï¸ No changes in prisma/schema.prisma â€“ skipping 'prisma db push'."
    fi
  fi
else
  echo "â„¹ï¸ No previous SHA recorded â€“ skipping automatic 'prisma db push' for safety."
fi

if [ "$RUN_PRISMA_PUSH" = true ]; then
  echo "Running Prisma DB push (will fail deployment on any error)..."

  set +e
  npx prisma db push
  PRISMA_EXIT=$?
  set -e

  if [ $PRISMA_EXIT -ne 0 ]; then
    echo "âŒ Prisma db push failed (data-loss warning or error). Failing deployment."
    exit 1
  fi

  echo "âœ… Prisma db push completed successfully."
fi

echo "Installing dependencies..."
npm install

echo "Building app..."
NODE_OPTIONS="--max-old-space-size=4096" npm run build

echo "Restarting PM2..."
pm2 restart api.dvi.travel || pm2 start dist/src/main.js --name api.dvi.travel

echo "Saving deployed SHA..."
echo "$NEW_SHA" > "$DEPLOY_STATE_FILE"

echo "ðŸŽ‰ Deployment completed successfully."
