name: Deploy API to DigitalOcean

on:
  pull_request:
    types: [closed]
    branches: [main]
  push:
    branches: [main]

jobs:
  deploy:
    if: github.event_name == 'push' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: SSH & deploy on Droplet
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}

          # <<< IMPORTANT: fail the job if any command fails
          script_stop: true

          script: |
            set -e  # exit immediately on any error

            cd /var/node-projects/api.dvi.travel

            echo "Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "Installing dependencies..."
            npm install

            echo "Building app..."
            NODE_OPTIONS="--max-old-space-size=4096" npm run build

            echo "Restarting PM2..."
            pm2 restart api.dvi.travel || pm2 start dist/src/main.js --name api.dvi.travel

            echo "Deployment completed successfully."
